---
# =============================================================================
# Create Virtual Key for Single User (Multi-User Loop Body)
# =============================================================================
# Called once per user from create_multi.yml
# Variable available: user_number (1, 2, 3, etc.)
# =============================================================================

# -----------------------------------------------------------------------------
# Step 1: Build User-Specific Variables
# -----------------------------------------------------------------------------
- name: Set user-specific variables
  ansible.builtin.set_fact:
    _current_user_name: "{{ litellm_vkey_user_prefix }}{{ user_number }}"
    _current_key_alias: "{{ litellm_vkey_alias }}-{{ litellm_vkey_user_prefix }}{{ user_number }}"
    _current_user_email: "{{ litellm_vkey_user_prefix }}{{ user_number }}@{{ litellm_vkey_user_domain }}"

# -----------------------------------------------------------------------------
# Step 2: Build Metadata for This User
# -----------------------------------------------------------------------------
- name: Build metadata for {{ _current_user_name }}
  ansible.builtin.set_fact:
    _current_metadata:
      alias: "{{ _current_key_alias }}"
      user: "{{ _current_user_name }}"
      user_number: "{{ user_number }}"
      models: "{{ litellm_vkey_models | join(',') }}"
      duration: "{{ litellm_vkey_duration }}"
      models_count: "{{ litellm_vkey_models | length }}"

# Merge custom metadata if provided
- name: Merge custom metadata for {{ _current_user_name }}
  when: litellm_vkey_metadata | length > 0
  ansible.builtin.set_fact:
    _current_metadata: "{{ _current_metadata | combine(litellm_vkey_metadata) }}"

# -----------------------------------------------------------------------------
# Step 3: Call LiteLLM API to Create Key
# -----------------------------------------------------------------------------
- name: Create virtual key for {{ _current_user_name }}
  ansible.builtin.uri:
    url: "{{ _litellm_api_endpoint }}/key/generate"
    method: POST
    headers:
      Authorization: "Bearer {{ litellm_vkey_master_key }}"
      Content-Type: "application/json"
    body_format: json
    body:
      models: "{{ litellm_vkey_models }}"
      duration: "{{ litellm_vkey_duration }}"
      user_id: "{{ _current_user_email }}"
      key_alias: "{{ _current_key_alias }}"
      metadata: "{{ _current_metadata }}"
    validate_certs: "{{ litellm_vkey_verify_ssl }}"
    timeout: "{{ litellm_vkey_api_timeout }}"
    status_code: [200, 201, 400]
  register: _current_api_response
  failed_when: false

# -----------------------------------------------------------------------------
# Step 4: Extract Key from Response
# -----------------------------------------------------------------------------
- name: Extract virtual key for {{ _current_user_name }}
  ansible.builtin.set_fact:
    _current_virtual_key: "{{ _current_api_response.get('key', _current_api_response.get('json', {}).get('key', '')) }}"
    _current_key_id: "{{ _current_api_response.get('key_id', _current_api_response.get('json', {}).get('key_id', _current_api_response.get('json', {}).get('token', ''))) }}"

# Validate key was created
- name: Validate key for {{ _current_user_name }}
  when: _current_api_response.status in [200, 201]
  ansible.builtin.assert:
    that:
      - _current_virtual_key is defined
      - _current_virtual_key | length > 0
      - _current_virtual_key is match('^sk-')
    fail_msg: "Key creation failed for {{ _current_user_name }}"
    quiet: true

# Handle key already exists
- name: Warn if key already exists for {{ _current_user_name }}
  when: _current_api_response.status == 400
  ansible.builtin.debug:
    msg: "WARNING: Key {{ _current_key_alias }} already exists. Skipping."

# -----------------------------------------------------------------------------
# Step 5: Store Results in Array
# -----------------------------------------------------------------------------
- name: Append key to results array
  when: _current_api_response.status in [200, 201]
  ansible.builtin.set_fact:
    _litellm_user_keys: "{{ _litellm_user_keys + [{
      'user': _current_user_name,
      'key': _current_virtual_key,
      'alias': _current_key_alias,
      'key_id': _current_key_id,
      'user_id': _current_user_email
    }] }}"

# -----------------------------------------------------------------------------
# Step 6: Display Success
# -----------------------------------------------------------------------------
- name: Display key creation success for {{ _current_user_name }}
  when: _current_api_response.status in [200, 201]
  ansible.builtin.debug:
    msg:
      - "âœ“ Created key for {{ _current_user_name }}"
      - "  Alias: {{ _current_key_alias }}"
      - "  Email: {{ _current_user_email }}"
