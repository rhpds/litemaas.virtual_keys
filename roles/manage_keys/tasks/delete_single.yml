---
# =============================================================================
# LiteMaaS Virtual Keys - Delete Single User Key
# =============================================================================
# Deletes a virtual key from LiteLLM
# Supports deletion by alias or by key_id
# =============================================================================

# -----------------------------------------------------------------------------
# Step 1: Set API Endpoint
# -----------------------------------------------------------------------------
- name: Clean API endpoint URL (remove trailing slash)
  ansible.builtin.set_fact:
    _litellm_api_endpoint: "{{ litellm_vkey_api_url | regex_replace('/$', '') }}"

# -----------------------------------------------------------------------------
# Step 2: Determine Key to Delete
# -----------------------------------------------------------------------------
- name: Set key identifier for deletion
  ansible.builtin.set_fact:
    _litellm_key_to_delete: "{{ litellm_vkey_alias if litellm_vkey_delete_method == 'by_alias' else litellm_vkey_key_id | default(litellm_vkey_alias) }}"
    _litellm_deletion_label: "alias '{{ litellm_vkey_alias }}'"

# -----------------------------------------------------------------------------
# Step 3: Display Deletion Details
# -----------------------------------------------------------------------------
- name: Display deletion details
  ansible.builtin.debug:
    msg:
      - "========================================="
      - "Deleting LiteLLM Virtual Key"
      - "========================================="
      - "Method: {{ litellm_vkey_delete_method }}"
      - "Target: {{ _litellm_deletion_label }}"
      - "========================================="

# -----------------------------------------------------------------------------
# Step 4: List All Keys and Find the One to Delete
# -----------------------------------------------------------------------------
- name: List all virtual key token hashes
  ansible.builtin.uri:
    url: "{{ _litellm_api_endpoint }}/key/list"
    method: GET
    headers:
      Authorization: "{{ _litellm_auth_header }}"
      Content-Type: "application/json"
    validate_certs: "{{ litellm_vkey_verify_ssl }}"
    timeout: "{{ litellm_vkey_api_timeout }}"
    status_code: [200]
  register: _litellm_key_list
  failed_when: false

- name: Initialize variables
  ansible.builtin.set_fact:
    _litellm_found_key_hash: ""
    _litellm_key_exists: false

- name: Extract keys list from response
  when:
    - _litellm_key_list.status == 200
    - _litellm_key_list.json.keys is defined
  ansible.builtin.set_fact:
    _litellm_keys_array: "{{ _litellm_key_list.json['keys'] }}"

- name: Search for key by alias
  when:
    - _litellm_keys_array is defined
    - _litellm_keys_array | length > 0
  block:
    - name: Get detailed info for each key and find matching alias
      ansible.builtin.uri:
        url: "{{ _litellm_api_endpoint }}/key/info?key={{ item }}"
        method: GET
        headers:
          Authorization: "{{ _litellm_auth_header }}"
          Content-Type: "application/json"
        validate_certs: "{{ litellm_vkey_verify_ssl }}"
        timeout: "{{ litellm_vkey_api_timeout }}"
        status_code: [200, 404]
      register: _litellm_key_details
      loop: "{{ _litellm_keys_array }}"
      failed_when: false

    - name: Find key with matching alias
      ansible.builtin.set_fact:
        _litellm_found_key_hash: "{{ item.json.key }}"
        _litellm_key_exists: true
      when:
        - item.status == 200
        - item.json.info is defined
        - item.json.info.key_alias is defined
        - item.json.info.key_alias == _litellm_key_to_delete
      loop: "{{ _litellm_key_details.results }}"
      loop_control:
        label: "{{ item.json.info.key_alias if (item.status == 200 and item.json.info is defined and item.json.info.key_alias is defined) else 'N/A' }}"

- name: Debug key search results
  ansible.builtin.debug:
    msg:
      - "Key search results:"
      - "  Looking for alias: {{ _litellm_key_to_delete }}"
      - "  Key found: {{ _litellm_key_exists }}"
      - "  Token hash: {{ _litellm_found_key_hash if _litellm_found_key_hash else 'N/A' }}"

# -----------------------------------------------------------------------------
# Step 5: Handle Missing Key (Idempotent)
# -----------------------------------------------------------------------------
- name: Skip deletion if key doesn't exist
  when: not _litellm_key_exists
  ansible.builtin.debug:
    msg: "Virtual key {{ _litellm_deletion_label }} does not exist. Nothing to delete (idempotent)."

# -----------------------------------------------------------------------------
# Step 6: Delete the Key Using Token Hash
# -----------------------------------------------------------------------------
- name: Delete virtual key via LiteLLM API
  when: _litellm_key_exists
  block:
    - name: Display key info before deletion
      ansible.builtin.debug:
        msg:
          - "Found key to delete:"
          - "  Alias: {{ _litellm_key_to_delete }}"
          - "  Token: {{ _litellm_found_key_hash }}"

    - name: Call LiteLLM key deletion API with token hash
      ansible.builtin.uri:
        url: "{{ _litellm_api_endpoint }}/key/delete"
        method: POST
        headers:
          Authorization: "{{ _litellm_auth_header }}"
          Content-Type: "application/json"
        body_format: json
        body:
          keys: ["{{ _litellm_found_key_hash }}"]
        validate_certs: "{{ litellm_vkey_verify_ssl }}"
        timeout: "{{ litellm_vkey_api_timeout }}"
        status_code: [200, 201, 204]
      register: _litellm_delete_response
      retries: "{{ litellm_vkey_retry_count }}"
      delay: "{{ litellm_vkey_retry_delay }}"
      until: _litellm_delete_response is succeeded

    - name: Display delete API response
      ansible.builtin.debug:
        var: _litellm_delete_response.json

    - name: Wait for deletion to propagate
      ansible.builtin.pause:
        seconds: 2

    - name: Verify key was deleted
      ansible.builtin.uri:
        url: "{{ _litellm_api_endpoint }}/key/info"
        method: GET
        headers:
          Authorization: "{{ _litellm_auth_header }}"
          Content-Type: "application/json"
        validate_certs: "{{ litellm_vkey_verify_ssl }}"
        timeout: "{{ litellm_vkey_api_timeout }}"
        status_code: [200]
      register: _litellm_verify_delete
      failed_when: false

    - name: Check if key still exists after deletion
      ansible.builtin.set_fact:
        _litellm_key_still_exists: "{{ _litellm_verify_delete.json.keys | selectattr('key_alias', 'equalto', _litellm_key_to_delete) | list | length > 0 }}"
      when:
        - _litellm_verify_delete.status == 200
        - _litellm_verify_delete.json.keys is defined

    - name: Warn if key still exists
      ansible.builtin.debug:
        msg:
          - "WARNING: Key {{ _litellm_key_to_delete }} still exists after API deletion!"
          - "This is a known issue with LiteLLM's delete API."
          - "Attempting database deletion if force_db_delete is enabled..."
      when: _litellm_key_still_exists | default(false)

    # ---------------------------------------------------------------------
    # Force database deletion (workaround for LiteLLM bug)
    # ---------------------------------------------------------------------
    - name: Force delete from database (workaround for LiteLLM API bug)
      when:
        - _litellm_key_still_exists | default(false)
        - litellm_vkey_force_db_delete | bool
      block:
        - name: Delete key directly from PostgreSQL database
          kubernetes.core.k8s_exec:
            namespace: "{{ litellm_vkey_namespace }}"
            pod: "{{ litellm_vkey_postgres_pod }}"
            command: >-
              psql -U postgres -d {{ litellm_vkey_postgres_db }} -c
              "DELETE FROM \"LiteLLM_VerificationToken\" WHERE token = '{{ _litellm_found_key_hash }}';"
          register: _litellm_db_delete
          failed_when: false

        - name: Display database deletion result
          ansible.builtin.debug:
            var: _litellm_db_delete

        - name: Wait for database deletion to propagate
          ansible.builtin.pause:
            seconds: 2

        - name: Verify database deletion
          ansible.builtin.uri:
            url: "{{ _litellm_api_endpoint }}/key/info"
            method: GET
            headers:
              Authorization: "{{ _litellm_auth_header }}"
              Content-Type: "application/json"
            validate_certs: "{{ litellm_vkey_verify_ssl }}"
            timeout: "{{ litellm_vkey_api_timeout }}"
            status_code: [200]
          register: _litellm_final_verify
          failed_when: false

        - name: Check final deletion status
          ansible.builtin.set_fact:
            _litellm_key_finally_deleted: "{{ _litellm_final_verify.json.keys | selectattr('key_alias', 'equalto', _litellm_key_to_delete) | list | length == 0 }}"
          when:
            - _litellm_final_verify.status == 200
            - _litellm_final_verify.json.keys is defined

        - name: Display final deletion status
          ansible.builtin.debug:
            msg:
              - "========================================="
              - "Database Deletion Complete"
              - "========================================="
              - "Key {{ _litellm_key_to_delete }}: {{ 'DELETED' if _litellm_key_finally_deleted else 'STILL EXISTS' }}"
              - "========================================="

    - name: Display deletion success
      when: not (_litellm_key_still_exists | default(false))
      ansible.builtin.debug:
        msg:
          - "========================================="
          - "Virtual Key Deleted Successfully!"
          - "========================================="
          - "Deleted: {{ _litellm_deletion_label }}"
          - "Verified: Key no longer exists"
          - "========================================="

# -----------------------------------------------------------------------------
# Step 7: Store Results in Fact
# -----------------------------------------------------------------------------
- name: Store deletion results in litellm_vkey_result
  ansible.builtin.set_fact:
    litellm_vkey_result:
      alias: "{{ litellm_vkey_alias }}"
      api_endpoint: "{{ _litellm_api_endpoint }}"
      api_base_url: "{{ _litellm_api_endpoint }}/v1"
      models: "{{ litellm_vkey_models }}"
      duration: "{{ litellm_vkey_duration }}"
      state: "absent"
      deleted: "{{ _litellm_key_exists }}"
      was_missing: "{{ not _litellm_key_exists }}"
      changed: "{{ _litellm_key_exists }}"
