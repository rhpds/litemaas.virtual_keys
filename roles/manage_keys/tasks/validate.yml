---
# =============================================================================
# LiteMaaS Virtual Keys - Input Validation
# =============================================================================
# Validates required variables before key operations
# =============================================================================

- name: Validate required variables
  ansible.builtin.assert:
    that:
      - litellm_vkey_api_url is defined
      - litellm_vkey_api_url | length > 0
      - litellm_vkey_alias is defined
      - litellm_vkey_alias | length > 0
      - litellm_vkey_state in ['present', 'absent']
    fail_msg: |
      Required variables missing. You must provide:
        - litellm_vkey_api_url: LiteLLM API URL
        - litellm_vkey_alias: Unique key identifier
        - litellm_vkey_state: 'present' or 'absent'
    quiet: true

- name: Validate models list for key creation
  when: litellm_vkey_state == "present"
  block:
    - name: Check models is defined
      ansible.builtin.assert:
        that:
          - litellm_vkey_models is defined
          - litellm_vkey_models | length > 0
        fail_msg: "At least one model must be specified in litellm_vkey_models when creating keys"
        quiet: true

    - name: Debug models type
      ansible.builtin.debug:
        msg:
          - "Models type: {{ litellm_vkey_models | type_debug }}"
          - "Models value: {{ litellm_vkey_models }}"

    - name: Parse models if string (handle command-line JSON)
      when: litellm_vkey_models is string
      block:
        - name: Try to parse JSON string to list
          ansible.builtin.set_fact:
            litellm_vkey_models_parsed: "{{ litellm_vkey_models | from_json }}"

        - name: Replace with parsed list
          ansible.builtin.set_fact:
            litellm_vkey_models: "{{ litellm_vkey_models_parsed }}"

    - name: Validate models is a list
      ansible.builtin.assert:
        that:
          - litellm_vkey_models is sequence
          - litellm_vkey_models is not string
          - litellm_vkey_models is not mapping
        fail_msg: |
          litellm_vkey_models must be a list of model names.

          Examples:
            Command line: -e litellm_vkey_models='["gpt-4", "gpt-3.5-turbo"]'
            Playbook:     litellm_vkey_models: ["gpt-4"]
        quiet: true

- name: Validate multi-user configuration
  when: litellm_vkey_multi_user | bool
  ansible.builtin.assert:
    that:
      - litellm_vkey_user_count is defined
      - litellm_vkey_user_count | int > 0
    fail_msg: |
      Multi-user mode requires:
        - litellm_vkey_user_count: Number of users (> 0)
    quiet: true
