---
# =============================================================================
# LiteMaaS Virtual Keys - Model Validation
# =============================================================================
# Validates that requested models exist in LiteLLM before creating key
# =============================================================================

- name: Debug models at validation time
  ansible.builtin.debug:
    msg:
      - "Models type: {{ litellm_vkey_models | type_debug }}"
      - "Models value: {{ litellm_vkey_models }}"
      - "Is sequence: {{ litellm_vkey_models is sequence }}"

- name: Get available models from LiteLLM
  ansible.builtin.uri:
    url: "{{ _litellm_api_endpoint }}/v1/models"
    method: GET
    headers:
      Authorization: "{{ _litellm_auth_header }}"
    validate_certs: "{{ litellm_vkey_verify_ssl }}"
    timeout: "{{ litellm_vkey_api_timeout }}"
    status_code: [200]
  register: _litellm_models_response
  failed_when: false

- name: Extract available model names
  when: _litellm_models_response.status == 200
  ansible.builtin.set_fact:
    _litellm_available_models: "{{ _litellm_models_response.json.data | map(attribute='id') | list }}"

- name: Display available models
  when: _litellm_models_response.status == 200
  ansible.builtin.debug:
    msg:
      - "Available models in LiteLLM:"
      - "{{ _litellm_available_models | join(', ') }}"

- name: Check if requested models exist
  when: _litellm_models_response.status == 200
  ansible.builtin.set_fact:
    _litellm_invalid_models: "{{ litellm_vkey_models | difference(_litellm_available_models) }}"

- name: Fail if requested models don't exist
  when:
    - _litellm_models_response.status == 200
    - _litellm_invalid_models | length > 0
  ansible.builtin.fail:
    msg: |
      ✗ Invalid model(s) requested

      Available models in this LiteLLM deployment:
      {{ _litellm_available_models | join(', ') }}

      Please use one of the models listed above.

      Example:
        ansible-playbook create_key.yml \
          -e litellm_vkey_api_url="{{ litellm_vkey_api_url }}" \
          -e litellm_vkey_alias="{{ litellm_vkey_alias }}" \
          -e litellm_vkey_models='["{{ _litellm_available_models[0] }}"]'

- name: Display validation success
  when:
    - _litellm_models_response.status == 200
    - _litellm_invalid_models | length == 0
  ansible.builtin.debug:
    msg: "✓ All requested models are available"
